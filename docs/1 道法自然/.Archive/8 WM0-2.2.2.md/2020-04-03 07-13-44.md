---
title: 水质模型项目流程
tags: 1000天持续行动,水质模型教程
date:   2019-6-18
---

读书笔记/热点追踪/论文研读/**教程手册**

>前面的几篇介绍了水质模型的背景知识以及其的类型，简单介绍了如何选择相应的模型，那么从本节开始涉及应用水质模型的相关流程。首先宏观的方面开始，从项目的角度来看下如何利用水质模型进行相关的项目，以及其的基本流程。


![总纲](http://comieswater-1254012817.cossh.myqcloud.com/2019/1568362958725.png)
# 类型
水质模型的应用场景实际上非常的多，可以说只有涉及到地表水体的**科学**治理和保护，就离不开水质模型，这点前面文章已经有所说明，这里就不再赘述了，具体见[水质模型的类型（1）](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247485208&idx=1&sn=0d6fd826d414fecbd0f46fe95e2559fa&chksm=a691fcbf91e675a98836bba16f241abba68fc86acc2030a4bd9cb5d70d143d05398f4788964f&token=647385879&lang=zh_CN#rd)。但是，目前水质模型的应用深度有所不同，我粗暴的将其分为广浅运用和窄深运用。之所以这样分是因为侧重点有所不同，我相信未来比如会融合为一体形成广深运用。

## 广浅类
所谓的**广浅**，主要是应用面较为广，但是应用深度较浅。其主要以信息化系统的形式展示，是现阶段水环境信息化后阶段的产物，多年来信息化逐渐在各行各业渗透，环保也不例外，各地都在进行环保数字化，环保这种公益性质产业必须紧密联系人民需求，而信息化则是助推的力量，通过移动互联网的技术手段降低公众参与环保的门槛。

>信息化、智能化可以助推水环境治理。例如，杭州推出的“五水共治”移动网络应用系统，让每个市民都成为治理的行动者。通过“杭州河道水质”APP，公众随时可以拍下水质差、污染严重的河道，并上传图片和具体位置。“零门槛”让所有公众都可以参与到治水监督中。公众投诉可以直接提交到相关负责人员，由河长领办，督促相关责任部门处理。这一制度创新突破了“有治理，无监督”的困境。通过线上线下双向互动，实现共同监督，共同治理。--来源： 中国环境报

但是信息化还需要为管理部门提供服务，环保信息系统的可以单独写一篇文章了，这里不进行展开，仅仅说环保相关的信息系统如果为部门的提供智能的决策，其中涉水的部分是躲不开水质模型的，也就是说将模型耦合到信息平台，从而为管理部门服务，目前大多数的应用场景有以下几种：
1. 让水体具象化。也就是能够看见管理的河流及湖泊的状况。当然看见不是说设立个视频监控，让用户能看到就行了，其还需要能够利用模型表达水体，能够在平台上看到水体污染物历史和现在的基本状况，也就是通过水质模型展示历史及现在的变化情况。
2. 风险追踪。自己在前面文章中提过水质模型的应用场景中说到这点[水质模型应用](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247485187&idx=1&sn=c4c71fad0a7f325ba2e047f5c12c593d&chksm=a691fca491e675b252721ea05bd7c6d0f4967adfd5c0dc95143c615961bc2ff589ad13db3ec8&token=647385879&lang=zh_CN#rd)，在前面能看见的基础上，对于水体面临的风险能够展示出来。短期风险，如突发性污染事故对河流、水体的影响，如偷排造成的水体水质的影响等。长期风险，城市发展带来的污染远期增长可能带来的水质变化。可以利用水质模型的情景分析功能进行模拟分析。
3. 短期水质预警。这个应用场景，目前还处于探索阶段，因为其强烈的依赖自动站的数据和模型的准确度，通过自动监测数据驱动模型对未来短期的水质进行预测预警，如同现在的天气预报，预测未来水质的变化状况。

信息化平台还有其他应用场景，只不过限于目前的数据水平，还不现实，不过未来可期。

## 窄深型
而对于另一种**窄深**，就是所谓的研究类项目，其最后的产出就是一份报告，但是其是决策支持的报告，不要小看这一份报告，其结论可能是作为政策的重要参考，就好像上面的信息化系统是民用，而这种研究类的就是军用的效果，其需要进行大量的测试校准，反复的确认你的模型结果，最后验收需要接受大量的公众及各个专家的质疑。美国那边常见的就是TMDL项目，耗时多年人力物力最后可能得出来的就是几个数字而已，但是这几个数字可是要作为各行各业未来努力的向导。这种项目相对于上面所说的信息化系统，其的应用场景可能就是解决一个污染物容量问题，但是其考虑的深度是非常深的，诸多细节都需要确定，还需要考虑各种不确定性因素。这种项目对于水质模型的应用多是：
1. 刨根问底寻因。水体目前的状况是由什么原因引起的，外源还是内源，应该重点关注哪些污染？富营养化的原因是什么？要能够说清楚目前水体污染的来龙去脉。
2. 求果。目前需要哪些工程能够让水质获得最大的改善，未来保护需要关注哪些因素？当前的规划能否实现水质的好转？

等等，上面一个问题就能让不用模型的人不知所措，让用模型的人伏案几月才能回答，这种应用实际上才是模型真正能发挥其实力的地方，但是由于其的难度较大，真正的做好需要非常多的资源和技术，目前国内还处于初始阶段。

当然，自己这样的分类过于粗暴，只不过是当前行业发展的初步产物，两种应用会逐渐的融合。信息系统会逐渐的深入下去，在平台中开展决策支持类的模型深度应用，这点需要信息化公司找到好的模型团队，不是开发软件就能解决的。同时，模型团队也会逐渐的把研究的报告变成信息平台，从而为用户提供长期的决策支持服务，毕竟开发的模型不断的维护升级才能发挥其的更多的价值。

- - - - -

**项目流程**
介绍完项目的类型，就开始项目的基本流程，两种项目实际仅仅在应用层面的深度、方向不同，其主要的步骤有：
1. 项目需求分析。项目的需求则是整个项目的基础，其决定了整个项目的基调，这个基调确定了模型应用的程度，决定了后面所有的流程应该怎么做，需要跟客户不断的沟通，明确客户最想要的东西，虽然细节的需要后面会不断的变化，但是应该确定一个边界范围，这点要达成共识。项目的需求重点在于一般情况下客户不是专业领域的，其只能告诉你需要实现什么，有的时候甚至其都无法明确需要什么，你要从专业的角度来引导“教育”你的客户，客户做完这个项目如果能够给你讲清楚模型，其知道模型能实现什么，不能实现什么，你的这个项目基本就算成功了。
2. 数据收集。数据对模型的重要性怎么强调都不为过，即使需求明确了，没有数据，一切都是白搭，巧妇难为无米之炊。所以数据往往应该和需求一起并行推进，从而确定真正的**可实现**的需求。很多时候希望有丰富的数据来顺利进行模型，但是经过几个项目的“打击”之后，认清楚了现实，数据可以作为模型从业人员的痛，不全是常态，有但获取不到也是正常情况，这时候就需要耐心的磨。另外，目前对于数据基础特别薄弱的，如果项目周期较长，也可以进行同步的测量，这时候利用模型来推动数据，也算一种手段。
3. 模型选择和开发。模型的选择，一般对现有模型、熟悉的模型进行优先选择，可能还需要考虑开源、闭源模型的问题，同时对于特殊的问题，还可能需要对模型进行模块的升级，甚至重新开发一个模型。
4. 模型构建。前面都是准备阶段，这里开始真正的进行模型的建模工作，这个阶段涉及数据的处理，数据的插值处理等，往往数据格式和模型所需要的有所不同，那么还需要对一些数据进行人为合理的处理，最后将其按照不同的类型输入到模型中，使得模型能够运转。
5. 模型校准。模型校准可以说是最关键的过程环节，简单说就是使得模型能够真正的表达实际的水体，之前我们一直说模型是实际水体的抽象，准确的说只有校准的模型才能说是反映了所模拟的水体。校准的过程还是模型技术的真正体现，不同的模型工程师差距非常大，模型校准的主要操作是**调参**，这个是最基础的操作，可以手动，自动，还会涉及敏感度分析等技术。
6. 模型应用。经过校准的模型就可以进行应用了，前面说的项目的类型就是从这里开始分道扬镳的，可以说这个阶段可以是享受成果的时候，到这里往往整个项目就接近尾声了。模型的应用也会有一些技术，比如不确定分析等来使得模型的分析的结果更加可靠。

综上，这些可以分为三大步：需求分析、模型建模、模型应用，需求分析是明白要为什么？做什么？模型建模就是怎么做了，最后就是模型的应用了。下节就详细每个环节进行展开。


>接上节，讨论了水质模型类相关项目的流程，主要有三大步：需求分析、模型建模、模型应用。本节就逐个进行其的详细解释。

![项目需求分析](http://comieswater-1254012817.cossh.myqcloud.com/2019/1568472231043.png)

# 需求分析
我将项目需求分析和数据资料收集归为一类，是因为这两部分实际上属于为建模的前期准备阶段，对于项目而言，这时候也是密切和业主对接的阶段，无论是项目目标，还是数据的获取都需要和业主密切的互动，需求的分析和数据都需要实地的进行调研，脱离实际的模型不具有价值。这个阶段的主要任务就是明确**项目的目标**，对项目的内容进行**边界划定**，模型的**应用深度**进行确认；数据和基础资料收集，必要时确定相关数据的补充监测。

## 项目需求分析
接下来来具体的看如何进行项目需求的分析，这个阶段最主要的活动就是调研，虽然建模后期可能也会有几次补充的调研，但是那是对模型的细节进行确认，这个阶段的调研才是最全面和最重要的。

需要说明的是，最有经验的团队也要对接数次才能很好的沟通，所以不要对一次对接就搞定所有事情保有幻想，做好多次的准备。

调研的第一步，就是对研究对象进行初步的了解，从模型的角度去考虑一些问题，并通过互联网和客户等多渠道去获取有关研究对象的所有信息(包括新闻、论文、已有的项目报告等等）。记住是一切的资料，因为从事环保行业大家都明白，其涉及的领域非常庞大，基本可以是包罗万象了。

第二步呢，在了解了相关的背景信息后，比如明白了这个区域的气候、湖体是深水还是浅水等，就需要开始让客户提项目的需求了。这里需要注意的是，作为专业的人员，客户有时候并非专业，其可能只知道自己想要什么，也许知道其不想要什么，甚至有可能压根不清楚想要什么（这点可能大家觉得奇怪，但是确实存在的，很多时候你拿出成果其才说这就是我想要的东西，iPhone出来的时候大家都觉得没什么，几年过后大家才明白这玩意就是想要的真正的手机）。如果遇到这种客户，我们就需要“教育”客户，需求为其介绍模型，介绍模型的作用，模型能够解决什么问题，并多与其聊天，特别是从其**最关心的问题**出发，**引导带领**其一起学习，从而得到真正的需求，。因为我们都是为环保努力，要用自己的专业来实现客户的目标。

>举个简单例子，比如客户说现在是想要进行流域治理，但是资金有限，我该怎么办？这个时候实际上，业主想要的是实现资金使用的最大化，其不一定是钱的问题，转化为专业领域的问题，就是如何识别水体的污染源识别，对其污染贡献最大的是哪些，应该将这些资金优先用在哪些污染源的治理可以起到最好的效果。
>再比如，水质现在区域稳定，每年有固定的资金用于水体的保护，那么如何合理使用？看起来又是钱的问题，实际上其需要分析水体面临的风险，控制主要的风险防止水体水质出现退化。

这些例子过于简单，主要想表达的就是你如何发挥你的专业性来正确的解决问题。同时，客户一般都是对当地非常熟悉的，其有丰富的经验，跟其沟通也可也为我们后续的工作带来很多帮助，某种意义上是互相的学习。当然，这个需求分析的过程也不是一蹴而就的，只是我们能够初步的明白目前遇到的问题和需求。

之后，融合前面两步，就开始进行初步的分析了，当然这个分析并不是说非要在前面完成之后才进行的，而是整个过程都会考虑的，只不过此时是比较集中的过程罢了，以一个案例来展示下了解及思考的过程。

---

首先非常重要的，就是我们的目标，目标必须极其明确，才能往下做。X湖，业主的目标是需要用模型解决XX问题（问题略），而模型角度的目标是进行负荷削减，所以是两个目标，表面不同，实际最后有达到统一。

在明确目标之后，我们就需要进入执行层面，也就是技术路线，主要是从模型出发，该问题需要考虑的：一般和特殊。

一般问题就是对于在模型能力范围内的或者之前有相关经验的，都可以归类为一般问题，需要去从通常模型建模时需要资料数据出发，查看其是否完善，这类问题主要是花时间去找资料和整理资料，将过去的经验迁移过来，无非就是建模参数等的不同，在建模阶段具体考虑。

而特殊问题则比较关键，特殊问题是针对特定区域，特定水体其所独有的特征，且对模型产生重大影响的关键问题。比如对于X湖而言：
- 与其相关有特殊的农业灌溉，比一般的湖泊都要复杂，这个如何去考虑在模型中的表达，要知道这些系统的考虑是发展农业，数据有也是仅仅考虑的农业问题，而非环境问题，那么如何去在模型中表达这些复杂的现实。
- 生态补水的措施，对于补水其也是目前大多数湖泊有的人工入流或者出流，其这种人工措施对湖泊有什么影响，其如何在模型中合理考虑，甚至不考虑。
- 湖体的深度较浅，则其有大量的水生植被，这些植被可能有挺水、沉水，数据资料是极其缺乏的，那么模型的选择的时候就需要考虑这些因素，否则无法模拟。
- 水产养殖的面积可观，对其的影响不可忽略，如何在模型中合理表达鱼类的影响。
- 盐度，水体具有相当的盐度，模型中建模需要考虑盐度。

这些特殊的问题每个都让人头大，在建模过程中需要考虑的问题，也就是后面作为重点突破的，当然并不是说每个都需要完美的解决，但是这些问题都需要考虑，模型是现实的抽象和简化，但是关键的过程，影响大的过程必须要考虑，其他则依据情况而定，否则就做不下去了，导致整个项目的直接不做了。

这里需要声明立场，作为模型从业人员，当然希望自己有活干，但这只是一方面。从自己的经验来看，有时候模型一开始做的不太好没有关系，但是模型是能够不断的更新升级，模型的构建能够推动人们对水体的认识和保护，这点是非常重要的，不做模型可能这地方永远不会有数据，但是有了模型，在大家看到模型的初步成果之后，后面会有动力继续去做，因为客户会逐渐的明白，其想要解决的问题必须在什么条件下才能回答，从而有了一个正反馈，逐步的推进整个系统的运转，所以这个角度来说，如果宁可一开始差点，也不要不做，也是大学时代一位老师反复教导我的“**先求其有，后求其美**”。

需求实际上是渗透在整个项目中的，可能某个阶段会变的和最初预想不同，但是必须无论什么时候对接，我们都需要紧密结合模型来进行沟通。


## 数据收集
>继续项目流程，本节则主要说需求分析——有关数据的事情，我们知道数据对于模型来说是像食物对于人类，没有数据可以说就是没有模型。广义的数据不仅仅包括数字的资料，还包括其他诸如图像、文字等形式，这些最终都需要转化为模型能吃的数据融合到模型体系中去。

说起数据，简直就是模型工程师的梦魇，一肚子苦水，每次做项目的时候，数据这关可以说是头大，由于数据是不直接产生效益的（但是其非常重要，也可以理解嘛，发展过程如果收集一堆数据，理论上对于未来是好事，但是确实没有对当地产生实际影响，所以不重视数据也是正常的发展过程），我们现阶段的发展对基础数据的轻视，宁可多上点工程好歹有个效果，也不会去关注什么数据的事情。常见的情况就是没有数据，这也没有那也没有，好不容易听到有相关数据，你可别高兴太早，能不能获取到还是另一回事呢。不过随着国家的投入，数据之殇渐渐有了好转，有些地方逐渐建立起了数据体系，有时候甚至会由一些幸福的烦恼，数据好像有点多，哈哈，这时候呢，虽然大量的数据分析和处理工作需要做，但是比起没有数据的苦，作为模型工程师也会痛并快乐着吧。

闲话不说了，你看一提起数据来，我就有这么多感悟，足以说明数据对于模型的重要性了吧。数据这块先要进行的是与相关部门对接历史数据，如果模型研究周期涉及未来的，也有在对接过程中协调未来数据的对接方式。然后呢，就是实地调研了（实际上初步的数据获取到之后，模型的建模工作也会同步开始了，会进行模型的初步建模，也就是调研发生在模型初步建模之后），实地调研过程需要带着需求和建模时候的问题，建模的问题我后面讨论，现在简单说就是需求分析阶段的那些特殊问题要去现场确认。最后，对于没有的数据但是非常重要的数据进行补充监测，对于解决工程类项目，还需要进行同步的监测方案。

![数据收集](http://comieswater-1254012817.cossh.myqcloud.com/2019/1568730306120.png)

### 数据收集
需要收集的数据与需求紧密相连，前面也提到过一般问题和特殊问题，由于不同的研究对象特殊问题不尽相同，所以数据的收集工作就从一般问题开始，特殊问题的只能从自己有限的经验中，简单的列几条，同时也准备建立一个数据清单库，会不断更新遇到的案例，可以随时来关注本文。

前面说过，数据是广义上的数据，只要是相关的数据都应该尽可能的收集到，就连新闻都不放过。为什么呢？越多的数据则对水体的表达越好，举个简单的例子，如果想将富营养化的湖泊的磷模拟准确，单有磷的数据是不行的，其只能粗略的建模，必须有藻类、氮等其他指标综合，才能足够模拟富营养化的湖泊的磷。同时，因为目前数据的基础薄弱，数据往往很难有模型对应的数据，这时候就不同的数据综合分析判断。

模型都需要什么数据呢，这里从建模角度分析来说先说说为什么需要这些数据会更容易表达，所以我决定在后续内容详述，这里就简述。

模型建模需要的数据一般包括：
1. 气象数据，这个比较易懂，就是所说的天气数据，当然需要的指标比较多，气象的数据包括气温、气压、湿度等，数据从**气象部门**获取。
2. 水体地形数据，这个数据在前面网格的文件中已有详述，[网格地形](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247485161&idx=1&sn=af00357c963898d7ee4998f3eb081eb3&chksm=a691fd4e91e67458d623dd4d9fb049f52e1a31b4eeb49f0fcac36d97efa873b763a02bf129d7&token=1067183380&lang=zh_CN#rd)，这个数据由于其特殊性，之前很难获取到，一般没有什么部门测量，但是最近环保工程较多，使得比之前容易。小的河道建议自己去测量就好了，大的河道数据来源有以下几种，如果是河道的，航道管理局，当地的河道管理局；如果是黑臭河道治理，可能住建局或相关的市政工程部门，另外还有一个渠道，如果有清淤工程的，施工单位可能会有，但是其数据会提交相关建设部门，注意清淤前后的变化，需要模拟时期对应的地形。很多人都会去测绘部门，实际上测绘部门更多的集中在陆地上，水下地形不太会有，还有DEM数据也不是水下的，这点也要注意。
3. 水陆交界线（地理数据），这个数据用于描述水体与陆域的边界，一般如果对绝对位置要求不高（比如你不需要说具体的模拟桥墩受力分析这种），影像图就够了，要求高的需要高精度的加密水系数据，也需要注意时效性，这个可能在水利部门或国土部门，环保部门。
4. 边界条件数据，水文数据和水质数据。边界条件则为**驱动模拟进行的输入**数据，这些数据输入模型之后，模型从而能够运行起来。如果是模拟的河流，其的边界条件主要有上游支流数据，下游数据，点源污染数据，面源污染数据，而对于湖泊而言，则是入湖河流数据，出湖数据，取水数据，其他同河流。这些数据包括水位和水质，水文主要是流量和水位（流速也有用，但资料较少），水质则为污染物浓度。数据的频率越高越好，对接的部门水质数据一般在环保部门，而水文数据则在水文部门，水文部门也会有一些水质的数据，而点源污染则可能是住建部门，面源数据一般没有直接的，只能间接获取，从当地农业部门的资料推求，甚至需要流域模型来计算获取。
7. 校准数据，水文数据和水质数据。这个数据用于校准模型，虽然也是水文数据和水质数据，但是与边界条件有所不同，其功能不同：边界条件用于驱动模型运行的数据，作为输入数据来使用的，而驱动模型计算之后得到结果数据，在用校准数据和这些模拟结果比较，从而进行调参的方向。位置不同：校准数据对于河流而言，则是研究范围内的断面水文和水质数据（区分边界条件是其上游支流的断面）；湖泊则是湖体中的水文和水质数据（区分与入湖河流）。数据的来源则和边界数据类似。
8. 初始条件数据，模型启动时刻的初始条件，这个数据和校准数据的内容是一致的，只不过其用途是用于作为模型启动初始值。

上述就是模型普遍需要的数据清单，为了看起来更加清晰，列表如下：

![数据清单汇总](http://comieswater-1254012817.cossh.myqcloud.com/2019/数据清单_(1).png)

上述清单当然不全，只是非常的基础的数据让大家了解下。另外，针对湖泊特征及研究的问题，还有一些数据也非常重要，没有列上去的有：**底泥数据、水生植被数据、干湿沉降数据和闸坝的调度数据**等。

另外需要说明的是，随着信息化的建设，目前很多地方已经进行了部分数据的公开，除了与部门进行对接外，互联网上也能够下载到不少数据，可以去当地的省水利官网，生态环境厅官网，数据中心，湖泊河流管理部门去寻寻宝，本号也会收集一些网址后续放在公众号中，未来数据一定会越来越丰富的。

### 实地调研
实践的重要性不多说了，模型之所以能够反映实际，就是建模中考虑实际，贴合实际情况建模。对于实践的重点，目前自己的经验还不足以全面阐述，仅谈两个调研的重要任务，核实数据跟踪变化和特殊问题的抽象。

所谓的核实数据跟踪变化，主要是由于数据由采集到汇总发布，需要一段时间，这个时间内水体及周边是不断的再变化的，所以数据能否反映当前的实际情况需要去确认核实数据是否准确，同时对于收集到的数据中的监测断面，入流、出流位置，取水口等等都一定要去看看，这些对于后面的建模非常重要，只有心中有实地，模型才能做好。当然，调研看什么，不同的人有不同的视角，行家可能一眼参透一切，我可能需要蹲个一周。另外，建模过程肯定会遇到问题，那么可能需要多次跑，所以提前与熟悉当地的人建立比较紧密的联系，可以先询问下，其也可能解决你60%的疑问，剩下的就需要你亲自跑了。

另外，则是对特殊问题的抽象了，说的太玄乎，实际就是一些问题你只有在现场感受之后才可能有一些灵感，在头脑中想象如何去解决，我觉得实地调研最重要的就是所谓的感觉，对研究对象的了解，具体的感觉，可以给你建模过程带来很多信息。比如有些闸控问题，可能想象起来很难办，现场发现其压根是常年闸死的，这时候你直接不用考虑了，说了太巧了，不过就是实际发生的事情。

### 数据的补测
数据的补测，这块内容，实际也算数据收集的一部分，这部分内容是在数据收集之后会有个初步的补充清单，这个清单包括了一些建模必须要的关键但是确实无历史的数据。那可能就是同步建模和监测了，相关的监测方案又是另外一门技术了。还有一种情况就是建模之后，发现模型中有很多不确定性，这些需要数据来消除，那么就可能需要进行额外的数据补充。另外，对于工程类项目，长期的项目会使得其边界发生变化，这时候需要我们同步更新模型。

**小结**
本小结主要是聊数据，数据环节在模型项目中该如何进行，这里只是个人有限的经验，很多地方未必完全准确，不过数据的整个过程，包括数据的对接，监测等，后面的数据处理，均是模型项目最为花费时间的地方，这点也是整个项目的难点。



> 继续水质模型的项目流程，上几节围绕建模的准备工作进行了详细的叙述，本节开始模型的构建的环节了，模型的构建的目标就是完成模型的搭建及校准过程，为模型应用打下基础。在实际项目中，模型构建工作就是模型项目的核心，而这个环节又以模型的校准为重点和难点。模型的构建过程将其分为三大部分：模型选择和开发，模型的构建，模型的校准。

本节的内容为模型的选择和开发，可以看出选择在前，开发在后。这个之所以这么区分是因为实际**应用型项目**中，一般优先尝试使用现有成熟模型，而后针对具体的问题再进行局部的完善，所谓的站在巨人的肩膀上。如果针对现有模型不能满足要求，或者其他原因（如开源等因素），也会退而求其次找现有的开源模型进行深度修改构建，下下策就是完全从零开始构建一个全新的水质模型，当然研究学习除外。

# 模型建模
## 模型的选择

选择模型模型，在Steven C. Chapra老师的《Surface Water-Quality Modeling》书中写的非常好了，自己之前也有对其进行翻译：

> 我们在明确目标之后，我们就可以针对性的选择模型，一般使用已经存在且之前学者已经使用过的模型包，为什么我们要这样做？ 主要有以下理由，俗话说的好，我们要站在巨人的肩膀上。首先，如果之前有相应的成功应用的成果，那么我们利用起来的话，就不会发生重新发明轮子这种事情，毕竟重新构造一系列的方程组需要花费很多精力。更重要的是如果模型之前在其他地方成功应用过，我们就能够在他们经验基础上进行，并且可信度也更高，模型也是一种产品，对于其他地方成功的应用，我们当然会有更多的信心。----[模型的选择和开发](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247484282&idx=1&sn=aebf1d47a39b1575731e26d9c4e74904&chksm=a691f8dd91e671cb75b0335bea9c169383241a16a15fd75cd3572d499bcb3077f842730514ee&mpshare=1&scene=23&srcid=0513fDhTwyHfYVTskoliMy59#rd)

这里就不赘述了，详细的可以去看看。具体模型的选择，之前自己也写过模型的类型，可以跳转[WM0-2.2.1_水质模型的类型](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247485208&idx=1&sn=0d6fd826d414fecbd0f46fe95e2559fa&chksm=a691fcbf91e675a98836bba16f241abba68fc86acc2030a4bd9cb5d70d143d05398f4788964f) 。再具体的话，选择模型过程中会遇到一个具体的问题，就是所谓的同样一个模型有好多个版本，甚至可能有不同的公司开发，让初学者完全搞不清楚是怎么回事，如：EFDC版本。这就来解释下到底是怎么一回事。

### 模型的运行方式介绍

目前的模型，有不同的操作方式，有的是在图形界面上的，有的是在命令行的，还要是Excel的，千奇百怪，之前自己有介绍其的几种模式（具体可打开查看 ——[Delft3D的编译及运行](https://mp.weixin.qq.com/s/L4JdOvLUcbAKmwFCISlO4Q?)）：
>困难模式
我们知道数学模型本身内部是很多个数学方程组，那个年代的通过数学模型解决问题，就需要去手动列方程，然后求解方程，可以想象这个过程必然是庙堂之上的东西，一般人没有深厚的数学功底是无法做的。……
中等模式
随着计算机的普及，模型应用的广泛，必然科学家们也感觉到模型的复用问题，所以就考虑将参数从代码中抽离出来，放在一个地方（通常是一个文本文件），使用者仅仅需要更改这些参数，同时由于不同模型数组大小不同，计算机需要依据此管理内存，所以需要针对具体情况设置好需要的数组大小，那么每次都需要将其**编译**后，可以运行使用。……
容易模式
计算机行业的快速发展也会推动数学模型的发展，随着Fortan的发展，其有了动态数组（根据条件自动判断），同时将汇总的参数分类，在**可视化的界面**上表达出来，就形成了目前易用的商业软件包，……

好像没看明白，没关系，拿我们熟悉的东西来类比，模型的运行方式的发展有点像计算机编程语言（实际上两者密不可分）。在发展的初期，计算机语言为汇编语言，其用来驱动计算机运行。什么是汇编语言呢？基本等同于直接对计算机底层进行操作了，什么叫直接操作，所谓的计算机的核心部分cpu实际就是很多个晶体管组成的电路，而汇编语言就是用助记符代替机器指令的操作码，用地址符号或标号代替指令或操作数的地址。这个时候的特征就是底层操作，与细节接触非常的多，基本每个步骤都需要手动运行——这个对应水质模型的**方程困难模式，这个阶段对应水质模型的初级阶段，以S-P的模型为代表的采用方程进行求解，用户需求实际进行方程级别的操作，并进行相应的求解。**

![汇编语言](http://comieswater-1254012817.cossh.myqcloud.com/2019/1569539965316.png)

随后是发展出了高级语言，诸如C语言，其属于高级语言了，其可以理解为将汇编语言进行封装，以更贴近人的思考从逻辑出发，使得更加便于使用，用户不用每一步都去操作底层的机器码，而只需要采用表达式和语句来实现对计算机的控制。它不仅可以发挥出高级编程语言的功用，还具有汇编语言的优点，其虽然是高级语言，还是可以进行内存级别的操作。此时的特点就是相对的高级，经过一定的抽象，用户不需要一步步的十分细节操作，只需要调用一些高级的接口——而水质模型中则是**命令行，学过编程的人都被C虐过，这个阶段对应将水质模型内在的方程中的关键的参数提取出来，用户使用时只需要修改这些参数就可以进行建模分析，只在必要时进行底层的方程进行修改，当然这些参数中有很多底层的控制选项，诸如方程求解的方式等也是接近底层的**。

后来高级语言又有了诸如Python的脚本语言，Python的简洁之美大家有目共睹，用过的人都会感叹其的简洁且强大，足以让非计算机行业的人能够快速上手，更重要的是有非常多的库，使得用户的操作更加的方便。实际上其相当于基于C语言进行进一步的封装，其底层的操作如内存方面的垃圾回收等都自动化了——对应水质模型的**界面简单模式**，通过对命令行的封装，添加了完美的壳，让用户更加方便操作，同时如同python中的库生态，界面增加了数据的预处理、后处理的可视化等功能，使得用户能够方面快速的建模，但是其由于经过两层抽象，使得用户和方程相距较远，对方程理解不够时，可能遇到错误时，很难调试。

---

上面可以看出，越抽象，离细节越远，越方便，同时带来的弊端就是离底层越远，越黑箱化，越不够灵活，无法修改方程来获取自定义高级需求，同时限制于定制化的界面，很难进行系统的集成化（面对信息化平台而言），实际上，对于信息化平台来说其可能将模型的应用部分抽象出来，形成一个独立功能的模型，这样的抽象使得非专业管理人员也可以使用模型来进行分析。

>写到这里，自己发现上述的例子可能还是过于难了，比较很多小伙伴并不是编程出身，我就再啰嗦几句吧，拿我们熟悉的计算机来操作系统类比水质模型的各种模式，我们知道计算机刚开始计算时用的穿孔纸带，用其来操作计算机（实际上是输入数据），这个阶段就是非常初级的模式，后面微软的DOS命令出现（现在计算机上仍然保留的cmd命令行），虽然是一个黑色的框，还需要输入字母来操作，但是这个比之前操作计算机方便了不知道多少倍，再后面就是我们现在用的图形操作界面了。这三个阶段对应上述的阶段，大家可以体会下。

之所以这么多篇幅来介绍其的不同模式，就是因为很多小伙伴还没接触模型，就被各种模型及模型的不同版本搞的云里雾里，不同的模型模式也是伴随着模型的发展而形成的，其逐渐的降低建模门槛，使得模型能够应用的更加广泛，正如计算机的普及能够进入千家万户与图形操作界面有很大关系，互联网的普及是苹果首创的交互式手机操作系统的助力，模型的界面式也是使得我这样的都能迅速搭建起模型，降低门槛使得研究的人更多，反过来促进模型的发展。

那么，依据上述介绍，大家应该怎么选择模型模式有了一定认识。简单说如果你要进行研究学习，就从底层开始，甚至理论开始学起，如果需要集成应用，可能需要从命令行编程式开始，如果短期的应用项目或者研究生的论文，有界面的模型是最好的选择。

同时，还要一个目的，是为了从学习角度来，是了解不同模式后从而能把握其不同模式的特征，明白其的本质，弄清楚什么是重要的，依据自己的目的选择合适的学习的路径。

在谈模型学习过程之前，先说说有关模型不同模式的误区：

学习模型定要从底层方程开始，编程开始，甚至从方程开始才是正宗路径，用命令行模式的比界面要高级。错！方程重不重要，重要，但是对于初学者来说其并不是重点（为什么？后面模型开发会细说），用程序的底层版本就比界面要高级吗？不一定，初学者一定要弄清楚这个，不要觉得我从界面开始好像不够专业，学的不彻底。两者的本质区别是：是否能够用模型解决好问题，而用什么方式无关，只能说越接近底层使用，可能意味着使用者对模型的理解更深，这并不绝对，同时也还有习惯问题，有的可能就是之前师门在用这个，延续下来了而已。图形界面更容易上手，且有界面开发者的抽象，使得其能够更快的建模，从而使得初学者能够快速的进入状态，获取成就感，所谓万事开头难，突破这一关后面就会容易一点。所以我建议，**对于小白来说一定要找那种有界面的模型，可从界面开始熟悉，在对模型有了感性认识后再深入理解内部过程**，这个时候只有了解机理内部，才能进一步提升，当然再后面还需要一些艺术层面的想象力，因为模型是科学和艺术的结合。

具体到主流的水质模型，后面自己会针对主流模型进行汇总，现在就先说两个模型，比如Deflt3D和EFDC都有界面的版本可以试用。说到这里也会顺便简单介绍下这两个模型的情况，EFDC最初由John Hamrick(1996)年设计形成，本身是开源的，其对应的一个界面的版本EFDC_Explorer由Dynamic Solutions-International, LLC 公司以EFDC为内核，增加图形操作界面构成的，实质还是EFDC。而Delft3D是由荷兰Delft大学WL Delft Hydraulics开发的一套功能强大的软件包，也就是有图形界面的版本，但其内核的计算代码也2017年进行了开源（界面还没有开源，但是可以试用）。所以，初学者可以两者其一进行学习，其他诸如MIKE等，如果有正版授权，也可优先学，其教程最为丰富，没有正版不建议使用盗版，学习角度也不要，有法律风险。

模型的选择，一般对现有模型、熟悉的模型进行优先选择，可能还需要考虑开源、闭源模型的问题，同时对于特殊的问题，还可能需要对模型进行模块的升级，甚至重新开发一个模型。

## 模型的开发

模型的开发并非必须，之前总有人觉得学习模型必须是要能够开发模型，只有开发自己的模型才是牛逼，用现有的模型都比较LOW。对于模型开发而言，确实是有一定难度的，但开发一个好的模型，应用广泛，精度高，容错性强等就不是一件简单的事情了。国内前几年流行一股模型开发风，仿佛必须是自己开发的模型才能拿出手，用现有的模型都比较丢人，从应用角度而言，根本没有必要，现有的模型基本能够满足大部分需求，特殊需求也能通过局部修改来完善，没有必要去开发新的模型。所以学模型也没有必要上来就冲着要修改代码，必须开发一个模型的目标来学。正如，拿开车举例子吧，大多数人开车，更需要的是驾驶技术，而不是汽车的理论知识和汽车各个零件的运转情况，那些事情是汽车工程师做的事情，如果你从汽车理论开始学，汽缸怎么提供动力的，估计学个一年半载的，肯定没有开了一年的人驾驶技术高，只有对于赛车手，而且还是顶级的选手而言（一般水平的还是以驾驶技术为主导）才需要深刻的理解汽车的理论，从而在比赛中人车合一，但是其也不是了解到汽车工程师那种水平，其更多的还是了解汽车运转的层面。

模型也一样，现在数据分析师比较流行，实际上数据分析的职业主要可分为数据分析师、数据工程师和机器学习算法工程师，三者职责略有不同，数据分析师主要是挖掘商业信息，支持决策；构建数据流程，数据产品设计；商业问题量化分析；而数据工程师是承上启下的作用，主要是进行大数据开发的工作，为数据分析师提供分析平台和服务。而机器学习算法工程师，构建分析算法，更加的底层。

水质模型本身也跟这个类似，最底层的可为模型算法工程师，主要复杂模型的底层研发，从机理方程、数值计算角度开发模型；模型工程师可能进行底层算法和建模耦合工作，构建模型进行参数校准等；而模型分析师可能就是在构建好的模型上进行应用分析。当然，上述职位目前是不存在的，国内应该还没有细分到这种程度，仅仅是为了说明问题，这几个职责实际上也是模型应用的全过程，模型应用角度而言，主要集中在模型分析师和模型工程师的工作，后者为建模工作，前者为应用。而模型算法工程师则一般的项目没有到这个程度，除非涉及到特殊问题需求要完善代码。

模型开发本质属于很深奥的工作，需要强大的环境理论、数学、编程的功底才能完成，但是这部分工作基本对于使用、应用模型来说的必要性不是很大，所以将精力先集中在使用模型上，如何正确的使用模型上，也就是所谓的上面的模型工程师的任务职责，后面在需要时转向算法工程师学习。

如果你真的想开发模型，因为我也没有吃过猪肉，所以告诉你相关资料了。

```mindmap!?root=理论机理（内功）
  物理
  水力学
化学
  水环境化学
  化学动力学
生物学
  植物的动力学
  生态系统学
数学
  数值分析
  线性代数
计算机语言
  Fortran
  C++
```

![水质模型理论基础](http://comieswater-1254012817.cossh.myqcloud.com/2019/1569712487474.png)

有关模型的开发除了需要相关环境学科的理论知识，还需要在开发中注意下面的问题：

[水质模型构建（3） - ](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247484282&idx=1&sn=aebf1d47a39b1575731e26d9c4e74904&chksm=a691f8dd91e671cb75b0335bea9c169383241a16a15fd75cd3572d499bcb3077f842730514ee&mpshare=1&scene=23&srcid=0513fDhTwyHfYVTskoliMy59#rd)

[水质模型构建（4）](https://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247484284&idx=1&sn=139c94c3a980d5b1346e2df7cff0c4c5&chksm=a691f8db91e671cde48cc62848dd8eafa6d9e0d715ba07300a7c45a0d2b5866ae023ae3527dd&mpshare=1&scene=23&srcid=051579L6cCeDCYJFmgFsACSW#rd)


## 模型的建模
> 水质模型的构建，上几节围绕模型开发进行了介绍，本节进入模型的建模的环节，这里的模型构建，是更加具体层面的，是在模型选择好或者开发完成后，进行的仅仅是搭建起所研究区的框架，目标是使得研究区的模型能够初步运行即可，模型的结果准确则需要在校准环节进行。

模型的构建的过程呢，这个事情实在太简单了，我之前说过，水质模型的真正难点在于数据的处理和模型的校准，其他都不是事。如果数据是现成的已经处理好了，整个模型建模的过程，只需要最多半天时间，如果有好的前后处理工具，会更快。当然，需要记住我们的前提，**数据准备好且仅仅是搭建模型框架**。

但是，对于初学者来说，是非常难的事情，虽然操作层面基本没有难度，对照的案例也是分分钟上手，但是因为其涉及的概念和背景知识是非常多，导致初学者根本一头雾水，看着运行起来的模型，好像是那么回事，但是又那么多按钮，参数选项，忍不住想，这都是啥玩意啊，感觉放下案例，脑中一片空白，没法下手。本文就来好好聊聊这个建模的过程，献给没有师兄师姐指导的同学们。

对于一般的建模过程，经过了模型选择或开发之后，就具备了模型所需要的所有的部件了。为了便于理解，接下来我用一些生活中的例子来帮助理解建模的过程。

小的时候流行一种叫四驱车的玩具，这种玩具买回来并不能直接的跑，而是各种小的部件构成，有车的底盘，有发动机，都需要动手进行组装起来才能玩。那么模型有点类似，这个阶段我们已经有了各种的模块部件了，剩下的就是要把这些模块按照一定的方法来将其组装起来使得其能够运行。比如，有水动力模块、水质模块，那么你需要先设置好水动力模块，然后在此基础上添加水质模块，后续诸如水生态模块等等。

等到你熟悉建模之后，就会发现建模（单单说**建模**）看起来神秘，对于通用模型来说，其内涵实际是本地化，可以认为已经有了其他湖泊的模型，建模只不过需要将其替换为你的研究对象的相关**信息和参数**而已。诸如EFDC\WASP等都是水质模型的模板，我们之前毕业论文都用过Word模板，热心同学设计好，我们过来一套，内容换成我们自己的内容，其他大的框架基本没有变化。所以，当明白哪些是需要变的，哪些是小变甚至不变的，建模的问题就非常清晰了。

那么问题来了，建模究竟需要哪些信息内容呢？


### 想象力
我们来放松下，发挥想象力跟着去水体边看看。在地图上随便找了一个水体作为我们的建模案例。

![湖泊](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574086451608.png)

假设这个就是我们的研究对象，我们要用水质模型来模拟这个水体。我们知道模型是对实际世界的概化，那么我们就看看现实世界都有什么。

头顶的是天空，阳关照在水面上，还有云飘在空中，远处能看到太阳晒着的湖面上有空气在跳舞，景色宜人，随着风吹过脸庞，水面泛起阵阵波浪，空气中的温度刚刚好，看着美景你渐渐忘却了时间。

![天空](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574086212158.png)

不过转眼间一朵乌云飘过来，带来了几滴凉雨。

>对于湖体而言，将其独立为研究对象，那么其四面八方都与其有所物质交互，天空这部分可以概况为气水界面上的交换。这部分的交换主要有，能量如太阳辐射、热量；水量则为降雨；其他诸如气压、气温、相对湿度等等环境因子都对上述交换有影响。风也比较重要，其能够引起波浪，引起水流变化等。
![降雨](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574086272563.png)

然后你沿着岸边继续前行，看到有的岸边非常浅，能看到清澈见底，但是有的却深不见底，这时候你就需要小心别掉下去。远处的岸线曲曲折折，似乎把水体永远围在其的怀里。
>说完天空，就是陆地了，这部分主要就是水陆的界面上的，这个界面主要有两种类型，一种是岸上或地下水的交互，这个后面说。上面描述的景象中，主要是水陆的另外一种，固壁边界。水平方向上就是岸线了，而另外垂向就是水底的陆地了，岸线和水底的陆地将水整个围起来，是不透水的边界条件，在模型中表达是一种固壁边界条件，无水量交换。

![岸线](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574089276829.png)

再往前走你看到了一些河流入口，其上游弯弯曲曲的延申不知道什么地方去了，这些河流源源不断的给湖泊输送着水分。
>这个就是陆地上的另外一种边界条件，这个边界条件也是我们经常提到的【边界条件】，实际上仔细的读者，在阅读上面有关陆地和水体的交互中看到固壁边界不透水的时候一定会思考到水下的陆地还有地下水吗，怎么直接处理为不透水了，即使不说地下水，那陆地的水也会流入，怎么就固壁边界了呢？这个就是模型的概化和抽象了，是将这种水陆的交互区分为两种模式，一种就是完全不透水的，另外一种则来表达完全是水的。后者可以用来表达地表径流、地下水等，将其统一作为一种边界条件来处理（源汇项）。有点像物理思维，高中物理学习的物体的受力分析，将其分为重力、支撑力等，实际世界中都是合力，这样的抽象就是数学上更好的表达处理计算。

![入湖河流](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574089464228.png)

接着你看到了岸边的水里生长了一些水草，其在水中摇摆，有时还能看到一些气泡从水草从水下冒到水面。有时候能看到在水面上会有一些绿色的水团起起伏伏的飘着，这些看起来像一片水藻。

远处有人在钓鱼，湖里的鱼还挺大的，这些鱼儿靠水草和浮游植物而生。
>这里就是到湖体内部的动力学过程了，上面说的都是边界条件。首先湖体中会有水流的运动，那么水中的物质会随着水流迁移，物质本身也有扩散，可以认为是物理变化。不同的物质会进行相互的转化，进行化学变化，如硝化反应等；同时，由于湖体中生物存在，如藻类、细菌等，使得也有生物变化，一般无机物质被生物吸收，使得生物生长，同时生物死亡之后会变为有机质，从而完成循环。水中的鱼类、水草、浮游植物形成的食物链也是物质和能量流动的链条，这里都会对物质的量有所影响。


---
我们来小结下，我们模型建模需要的表达的过程。

![侧视图](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574576434004.png)

这里借用`环in圈`（李博）的一张图，我添加了一些内容。

1. 天和水的交界（水面的蓝线）：是气象要素，其包括气压、气温、相对湿度、降雨、蒸发、辐射、云量，风向和风速的考虑，这些在水质模型中一般称为**气象边界条件**，其对于模拟非常重要，理论上，必须有所高质量的数据（全部指标、高频率小时）才可以，但是针对不同复杂度的模型，需要的数据有所不同，如模拟河流水质，降雨可能不是那么重要，但是湖泊就极其重要，其降雨提供的水量非常的可观；针对蒸发量大的区域，蒸发就极其重要；模拟藻类，风及辐射和云量数据就必须要数据才能模拟准确。
2. 水和陆地交界（棕色区）：陆地的固壁边界和入流的边界，固壁为水下的陆地和岸线陆地（下图中的俯视图的黑色线），而入流则为图中的管道示意图（俯视图中的蓝色河流线），以及地下水的交互。这里对于模型中来说主要是两部分，固壁边界对于**网格**（水平固壁方向为网格的外围边界线，垂向固壁为网格的地形）；而入流边界则为我们的**入流边界条件**了。
3. 水体内部的物理、化学、生物动力学过程。如水中的水草和鱼类，物质和能量的循环，其过程比较复杂，以EFDC的基本富营养化动力学为例，营养物质与水草和藻类的交互作用。上面的两种边界条件相对于模型的**驱动力**，而这里就是**水体内部的动力学**机理方程了，这个在模型中一般就是调参的重点了。

![俯视图](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574576685247.png)

![富营养化动力学](http://comieswater-1254012817.cossh.myqcloud.com/2019/1574576755891.png)

这些过程也就是我们要在模型中表达的这些过程，这节就先热身下，以大家熟悉的事情来跟模型术语串联起来，下节我们就开始正式建模过程了。

> 上节从现实世界出发，介绍了我们的模型模拟的量，同时结合前面章节的数据需求，说明了那些数据具体所起到的作用，本节则具体的开始介绍模型的具体建模步骤。

不同的模型建模过程细节会有所不同，但是其的基本步骤是基本一致的，那么就从相对通用一些的角度来阐述下模型具体的建模过程。

先简单进行回顾，到这节，我们可以认为经过需求对接，清楚了的模型要实现的目的，进行了调研，获取的模拟对象的基本信息情况，同时数据也收集的差不多了，也进行相应的补充监测，未来能够获得相应的数据，按照需求选择或开发好了相应的模型，开始要搭建模型了。

## 想做什么？能做什么？

想做和能做之间是有距离的，之前在模型的选择时，讨论了需求和现实之间的平衡，这里再次拿出这个问题来就是说，因为那个时候往往是初选，大概明白什么模型完全不能用，这个时候的第二次选择，就是落地到具体的对象上了。我从两个角度来进行分析：

### 空间角度

空间角度也就是选定模拟的对象，注意这个对象可以称为控制体，之前水力学中也都经常提这个内容，就是选定一个区域的水体作为研究对象，这个对象与周边隔离开来，单独对其进行分析。而此时有点类似，要选定我们将要模拟的对象，具体到湖泊而言，除非特殊需求下，湖泊是被隔离的，隔离部分具有相对独立的特征，否则一般是模拟整个湖泊的。

但是对于河流而言，就未必了，河流的特点是空间跨度可以非常大，有些河流候非常长的，有时候我们并不是关注河流的全部，而可能就是局部的区段。那这个时候就需要选择对于的模拟范围，将其隔离出来，需要注意的是隔离需要考虑几方面，这几方面取**并集**，也就是最大的范围：

1. 需求段。业主关心的问题出发，其关注的区段肯定是我们需要模拟的，这个没有什么特别需要说的。
2. 校准数据范围。由于我们的模型需要校准，所以如果选择的区域最好覆盖所有观测数据，因为数据本来就少，能够多用上尽量用上，当然，不是说有这个数据就必须用，而是说在大的数据集上进行分析验证会使得模型更加可靠。
3. 边界条件范围。这个更为关键，也经常被忽略，这种隔离体最需要的就是隔离的部分与外部的交界处的信息，是建模的基础，如果没有边界条件驱动，模型就无法运行，所以边界条件十分重要，哪里有边界条件基本就需要其作为区域范围的边界。
4. 研究对象受到的影响，这点实际是第3点的补充，但是要单独强调下，对于研究对象受到外部条件的影响，则其需要将外部影响考虑进来，典型的如入海口，由于海洋的潮汐，其常常可能有周期回流，那么这个回流就对研究对象有影响，所以其的范围就要伸入海洋之中。

需要说明校准数据和边界条件都是实际监测的数据，只是根据其用途不同将其重新按照模型的术语划分的，如同手机之前也可以看电影叫电影播放器，可以听歌就说是MP3，能通信就说是电话，当然还有时候被叫做锤子，因为可以砸核桃；边界条件和校准数据的关系，在湖体中两者一般是界限较为清晰，对于湖体中监测的就是用于校准数据，而入湖河流这些就是边界条件。但是在河流中，这两者并不是那么清晰，比如某断面，如果其有流量和水质数据，隔离体的范围设置在这个地方，那么其就是作为边界条件，但是如果某些原因，范围扩大到断面的上游了，这个时候该断面的数据就作为校准数据用了。

边界条件和校准数据的区别前者是**输入数据**的一部分，用来驱动模型的；而后者则是用来作为模型结果的匹配目标，即所有输入完成后，模型运行之后的模拟结果与校准数据进行比较分析，调整参数使得模拟结果与校准数据匹配。

在弄清楚这个关系之后，边界条件和校准数据怎么用就随你了。

### 时间角度

一般我们使用的都是动态模型，也就是需要模拟出变量（水质指标）随时间变化的结果。那么，其就需要考虑时间因素，就是所谓的模拟的时段范围。由于是动态特点，所以输入的数据应该是时间序列数据，从数据出发选择数据质量较好的时间范围进行模拟分析。

所谓的数据质量较好，就是指一段时间内的较多的有效数据，如错误较少，异常值较少。对于模型角度来说，还有一个较为重要的就是频次。目前监测数据来源两种形式，一种是人工巡测的数据，另外一种则是自动站的数据。前者，频率较低，每月能有一次就已经非常好了，但其数据可靠性强。后者，频率高，高频能够到达数小时，甚至分钟级别，但是其由于通过传感器测量，目前水温、溶解氧还算可靠，其他的水质数据可靠性不强。

那么究竟要什么频率呢？答案当然是越高越好。但是理想丰满，现实骨感，实际项目中的数据都是用珍宝，非常稀有，那是不是说我们的项目就没法做了呢？像月尺度的水质数据究竟能不能用呢？怎么用？

这里需要说明存在时间尺度的问题，如果有月尺度的数据，那么可以认为模型在季节尺度上可以应用，月尺度也可以勉强使用，此时虽然模型的结果可以输出日尺度的数据，但是不具有太大的意义。同样，如果有小时尺度的数据，可以在日尺度上有较强可信度。当然，需要特别说明的是，这只是一般的入流边界条件的情况，具体情况还要具体分析，比如对于气象而言，其由于日尺度上存在显著变化变化，若模拟藻类的变化，其需要小时尺度的数据，来模拟昼夜交替的光合作用，这部分会对藻类有非常大的影响，如果不输入小时的变化，那么从误差角度日积月累误差会非常的大。

另外，如果对于实在缺乏的数据，则可在理解模型的基础上，对数据还可以进行人为的处理，注意这不是造数据，而是合理的概化，所以务必谨慎又谨慎，记清楚前提假设。

一类为插值、统计推导等。如对数据进行线性插值形成连续的时间序列，或者回归分析，其他统计方法来进行推求，记得当时学习水文课程时，课本就有提到对于缺乏数据的地区，可用同区域、特征相同的的数据替代，这个对于水文数据可以近似这样处理。对于日尺度的降雨数据进行小时的平均分配等等。总之，推导的数据并没有引入信息，降低信息熵，反而可能会引入非常多的不确定性，所以要你明白你在干啥。

第二类为物理规律计算。通过物理规律进行一些数据的推求。如太阳辐射数据相对缺乏，如果有日照数据，那么结合太阳的周期运动，依据不同纬度是的理论值计算，那么我们可以计算出太阳辐射的周期变化数据，当然这个理论计算的是到达地球表面的，其没有考虑云量等遮挡，但是比起没有还是要好很。云量数据呢就是通过当地的历史观测数据，推断出雨季和非雨季，雨季云量多点，非雨季云量少点；对于蒸发，也可以根据相对湿度，气温等利用经验公式进行计算。这些方法都是没有办法的办法，都需要经过敏感性测试才能使用。

无论如何数据怎么都不嫌多，很多不相关的数据如果有就可以先收集到，这样后面可能有用。


> 继续建模过程，上节主要是建模的初步处理，本节开始建模型的有关具体操作。

首先，对于模型有前处理和后处理的过程，所谓的前后实际上是以模型的运行为参照的，前就是模型的运行前的处理，模型后处理就是模型运行后的处理。所以，前处理过程也就是我们现在的建模过程。

## 网格划分

网格划分是建模的第一步，对于非零维模型，都需要建立网格。网格的含义，在之前的文章中有叙述，可查看[网格](http://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247484785&idx=1&sn=b788947dfdfa843869b4b12d0aafbdbb&chksm=a691fed691e677c028ac8aba70ef5f1525e2f0d0b875a61d71157bcaa6e957d9177b403904b6&mpshare=1&scene=23&srcid=1130gi1hNXbGghihzCSWh8HF&sharer_sharetime=1575124119677&sharer_shareid=dfe084df7356a3bdc07125647f3481ab#rd) [网格2](http://mp.weixin.qq.com/s?__biz=MjM5Mzg1MzEyOA==&mid=2247484795&idx=1&sn=f364ba3ee182c58f5960b9c0f2f0695c&chksm=a691fedc91e677ca610c386186b1283237420fda9d7fc3df520db4688acc7b04bdf5a3fba984&mpshare=1&scene=23&srcid=1130o63GJnPnE4PQni5QzIWy&sharer_sharetime=1575124177381&sharer_shareid=dfe084df7356a3bdc07125647f3481ab#rd)文章。这里简单谈谈我的看法，划分网格的主要是因为计算的需要，因为水质模型底层的物理规律是基于多个微分方程的，如N-S方程，但这些方程式并不是所有都能求解解析解的，那么牺牲精度换得能计算，跟我们一直强调的『先求其有，后求其美』一样，采用数值计算的方法进行近似求解。当然，数值计算的方法有多种，如有限差分法、有限体积法等，但是不管哪种方法，都需要将研究对象离散化，也就是划分相应的网格。

另外，一种角度是在学习<地表水模型>时候想到的，Chapra先从零维模型开始切入，后介绍了正馈系统和反馈系统，即利用多个零维模型串联而成，明确多个零维之间的关系，联立即可构成最简单的一维模型。所以，所谓的网格化可以理解为多个零维的简单模型有机组合起来表达了空间上的变化。

网格的划分针对不同的水质模型，有不同的划分方法，商业类软件比较友好，目前都有较为成熟的工具，开源模型就比较麻烦点，一般需要借助其他工具，这点往往成为新手的拦路虎，所以建议大家一开始学从商业模型入门比较好。好消息是现在讲究开源，有很多的开源算法能够很容易的生成网格，坏消息是生成的网格还需要根据模型的指定的格式去制作。

水质模型的网格目前主要有两大类：结构化网格和非结构化网格。结构化网格在计算方面有一定的优势，但是非结构化则对局部的研究对象的刻画比较方便，且整体比较容易绘制，其基本不需要技术含量，可以直接无脑生成，不用考虑结构网格中的贴边，正交之类的，也是未来的趋势，但是目前来看，水质模型领域结构网格仍然是主流。

这里贴一张delft3D官网的一张示例图：
![Delft3d官网示例](http://comieswater-1254012817.cossh.myqcloud.com/2019/1575296143630.png)

网格对应前面节提到的固壁边界，水平方向则是是网格最外围线来表达，而底边界则是由水下地形来表达，从而将研究对象完全隔离出来。一般情况下，只要表达清楚研究对象，到此就结束了，但是对于复杂的研究对象，网格的玩法就更为多样了。可能有以下问题需要关注：

1. 内部区域有岛或者深沟。对于这些区域由于地形变化起伏大，在模型计算过程中容易出现发散，需要特别的处理。对于较大的岛屿来说，依据实际情况，可将网格挖去，直接将岛屿作为固壁边界。但是对于小一点的岛屿来说，其有可能会有水淹没或露出，那可以设置其实际的底部地形，采用干湿模式处理，什么是干湿模式呢，下面会说。但是一般情况我们还是尽量挖去，即让其不参与计算，不好处理，我就直接不处理了。而深沟和岛是相反的，其的问题是梯度的变化，也就是地形的变化太大，容易导致计算问题。
2. 存在浅滩，可能部分时段是没有水的。这种情况对于宽阔的河流或者入海口比较常见，这些区域在水量较大时是处于有水状态，而在水量较小时，其处于滩地。那么，问题来了。我不可能像岛屿一样直接挖掉，那么我在有水的时候，本来是应该扩展到这些区域的水，由于没有网格，成了固壁边界，这些水就会壅高，与实际情况肯定不符，所以必须还是要用网格表达这些区域的，那么现在的问题就是这些网格如果没有水如何表达？方程求解是一视同仁的，并且计算的是**水流这种物质**，如果这个网格没有水，那么是无法进行计算的。那么就出现了干湿网格动态边界模式，所谓的干湿模式就是网格没有水的时候将其从计算中暂时除去，在有水时再变为湿网格继续计算，就解决了这个问题，当然这里与网格本身关系不大，而是一种计算模式的处理。
3. 地形变化剧烈，有些河流上下游高差较大。学点数值计算对理解水质模型是有帮助的，因为你可以理解网格的平滑、正交究竟是为什么？对于地形变化剧烈的时候，需要进行一定的概化平滑操作，而对于河流的上下游高差，则需要注意其整体的坡度状态，模型内部方程的假设条件，能否适用这类问题。
4. 内部或边界上存在水工构筑物。这类问题与岛屿类似之处，一方面可能需要对网格进行处理，网格线与这些贴合，使得其流场符合，另一方面可能需要根据模型本身的功能进行一些具体的处理。

## 边界条件输入

气象条件输入，气象从某种意义上也是边界条件的一种，如同网格表达了固壁边界一样，但是我们传统不将其称为边界条件。气象条件按格式输入即可，有关的气象的细节可能就是尽可能**高频**的**连续**数据，注意模型内部使用的**单位**即可。

水量、水质、水位等这类边界条件是驱动模型的边界条件，简称边界条件。边界条件，先说水质的边界条件，其在水质模型中通过两种方式，一种是负荷的方式，另外则是浓度的方式，本质是一样的。负荷相对来说是比较粗的形式，常见的是以浓度居多，因为存在不同的浓度和流量的组合。

再强调下，观测数据用于校准模型结果，而边界条件则为驱动模型运行的数据，主要是看数据如何使用。

首先，谈下动态模型的边界条件的时间序列，所谓的时间序列是由时间和值一起构成的数据列表，也就是数据具备时间属性，常见的如气温、降雨等数据，如下图所示为中央气象台的气象要素的时间序列图，图中的每个点都是一个数据。

![enter description here](http://comieswater-1254012817.cossh.myqcloud.com/2020/1580462103062.png)

对于时间序列，时间频率非常重要，就是数据的时间间隔是多久一次的，间隔小时为小时尺度的数据，数据的频率对于模型来说影响非常大，不同的模型需求，需要的时间尺度不同，但是基本都是越高越好，毕竟高频数据能够降维为低频数据，低频数据不太好升维。

模型对于时间序列的使用，一般是会自动进行线性插值呢，简单的说就是上面的相邻的两个点的数据直接线性连接，两个时刻点中间的值就是线性计算出来的。这个主要是对于不同时间频率的数据混用时需要关注的，比如你的流量数据是小时尺度的，但是水质数据是日尺度的，两者作为模型的负荷输入时，这两套数据内部怎么使用的，就需要弄明白了。

### 水动力边界条件

那么，就说说几种常见的水动力边界条件。

- 流量边界。通过流量的方式输入到模型中，有恒定流量（恒定不变的流量）和流量时间序列（流量随时间变化），用于入湖河流、河流上游断面的来水，这比较容易理解，就不多解释了，需要注意的地方就是出流的流量边界可能是以负数表达，或模型自己规定的方式。另外，对于具体模型设置方面，对于流量边界的实际设置，需要注意多个网格的流量分配问题，之所以分配，一方面是要匹配实际情况，另外也为了计算上的稳定，比如具体而言如河流横断面有多个网格，则多个断面网格上进行流量的分配（对于宽的河流，其整个横断面上并不一定是均匀的流量）；而深度方向考虑，多层的网格，存在垂向分配的问题，就是表层流速快的情况，对于湖泊呢，入湖河流流量大的时候也可分配到多个网格上（因为网格分辨率并不一定就是等于入湖河流宽度）。
- 水位边界条件。给定的水位随时间变化的序列，直白点说就是设置某位置的水位为给定的值，这种水位边界用在河流或者海洋的开边界上，因为其的“能量”非常的强大，且多用于下游（外海）位置处，实际使用时务必注意这种边界有可能会引起一定的回流，那么与之匹配的水质边界就需要设置的比较合理，否则会出现很多问题，对于有回流的可以考虑。
- 水位——流量边界。这是一种通过水位——流量的关系确定的一种边界条件，输入这种边界后，模型会通过边界位置处的网格的实际水位来确定其出网格的流量，对于一般的河流，这种水位-流量边界条件更加的合理，因为这种边界条件是**单向**的，不会有回流产生，而水位边界条件是可能有回流的，同时对于湖泊出口一般是闸控或者溢流坝的，溢流坝的本质就是水位——流量关系，水位到达一定值，其按照一定的流量出流，所以这种边界条件也是应用十分的广泛，这个和上述的水位边界的特征不一样，要注意区分。

### 水质边界条件

对于水质模型而言，水动力边界条件仅仅是模拟水动力模型，水质模型需要有水质边界条件，水质边界相对来说比较单一。一般为浓度边界，当然也有负荷边界，但是两者没有本质都不同，其最终都为往系统中输入负荷。对于浓度边界，一般多与水动力的流量边界边界配合使用，通过流量与浓度的组合来进行实现负荷的输入。

水质边界需要强调的是输入的水质指标和指标的单位。这个需要根据模型所描述的量进行具体的匹配。指标的名称和单位一定要反复确认，这个非常的重要，很容易出现牛头不对马嘴的错误，我们都知道汽车加油要有对应的型号，如果加错了，轻则动力不足，重则发动机损坏，所以务必注意。

大家需要根据具体的模型，仔细核对说明书。现在仅仅根据自己的经验，举几个简单的例子，以EFDC为例，水质指标的问题，最常见的一个错误就是其中的COD,模型中的COD表达的是仅仅甲烷等无机物消耗的氧气量，而非国内的化学需氧量，看到一些同学拿这个COD去模拟化学需氧量，不管你模型设置的多么好，校准的多么好，不好意思，都是错的。

单位方面呢，一个坑就是叶绿素a了，对于叶绿素a的单位，我们通常用的都是ug/L，但是对于efdc模型而言，其并非直接模拟叶绿素a的，而是通过生物量来进行模拟，其是以 碳 计量的，对于水质边界条件的输入单位是 mg C/L，所以输入模型时，必须输入是转化为碳计的量。

## 初始条件

水动力和水质的初始条件的设置基本类似，将模型模拟开始时刻的数据输入模型作为模型运行开始时刻的初始场。比如，对于河流的模拟，从2020年1月1日，0:00开始的模拟，你需要输入这个时刻河流所有的状态，模拟区域所有位置的水位、水温、水质指标浓度，甚至还有流场的情况（位置通过网格来体现），对于湖泊也是一样的。单纯考虑模型的初始条件，*假设模型的边界条件是正确的，参数也是正确的*。那么输入初始条件后，模型在边界条件驱动下开始运行，模拟的结果就即刻开始可以使用了，代表了真实的结果。

这个是理想情况，你也知道这个显然是不可能的，根本就没法获得上述的初始条件，那么我们究竟要怎么办？

先从模型的机理角度来看，初始条件在经过多个时间步长后，其的作用在模型中会逐渐“消失”，换句话说，不管设置的初始条件是什么样，经过**足够长**的时间后，其对该时段的模拟的影响都会消失。从这个角度来看，我们根本就没有必要设置初始条件了，随便设置一个就可以了。

那我们还为什么要设置初始条件呢？理由就是前面的**足够长**，如果设置的是正确完全的初始条件，这个足够长实际上几乎就是0了，就是上面的理想情况。那么我们如果输入的是完全错误的（这个当然是为了便于理解举例而举例），那么这个足够长就是无限长。

那输入有限的初始条件，需要的时间就介于0～无限长之间了。我们称这个时段为热身时间，热身时间有如下特点：热身时间内的模拟结果是无效的；真实的初始条件，热身时间=0。

输入的初始信息越接近真实情况，那么**热身**的时间就越短，我们无法获取到真实完备的初始条件，但是能够输入足够多的初始信息的话，就能使得热身时间足够短。这个时间短有什么用呢？比如你只有两年的数据，如果热身的时间为一年，那么模型有效的结果只有一年了。

有关这个热身时间，水动力和水质的热身时间不同，水动力的范围几小时到几百天不等，水质的一般都需要数月。所以水动力的初始条件可以随意一些，而水质的初始条件就需要尽量的设置好。此外，不同类型的模拟对象，热身时间也不相同，河流的一般要短于湖泊，这个与水动力条件、内部动力过程等相关。

**热身**实际上在水质模型中有专业的术语，有关Cold start（冷启动）和Hot start（热启动），就是说这个的，具体的这里不深入阐述了。

回过头来说初始条件的信息，初始条件是一个场，但是往往没有那么多的数据，那么其需要进行空间的插值，具体的插值的影响也会影响热身时间，但是这个并不是关注的重点，因为其插值本身并没有引入有效的信息。

对于场也有例外，就是在湖泊中的水位，湖泊较小时其湖面是水平面，所以其直接均匀场，不过均匀场也是一种特殊的场。

------

**小结：**

在上述所有条件设置完毕之后，模型已经有了基本的框架了，模型就可以运行计算了。

到此模型的基本建模已经完成，这里忽略了一些过程的设置，如模型模拟的物理过程选择，是否模拟风、盐的作用，因为不同的模型有所不同，不能一概而论。

那么，从上述过程可以看出，模型的建模过程如同搭建积木，逐步的将各个模块组合起来，最后形成了整个模型，后续缺少什么还能进行细节的完善，但是基本的框架基本不会变了，整个建模并不复杂，只要数据足够，建模过程非常的容易，理解了基本的概念之后，按照通用的步骤去操作即可。




由于教程系列文章需要花费很多时间，难免出错，而这里不能进行后续完善，所以推荐大家关注我的博客，获取最新的修正和补充。
公众号的**社群**同步开启，感兴趣可在公众号对话框回复“社群”，获取群号和加入方式。

---


![页尾](http://comieswater-1254012817.cossh.myqcloud.com/页尾识别new-2017-09-22.png)
微信公众号 | 水环境编Cheng长
网          站 | comieswater.com


![赞赏我](http://comieswater-1254012817.cossh.myqcloud.com/IMG_3077.JPG)

 2019-6-18

 folder=/微信公众号/水环境编Cheng长/

[1]: http://comieswater-1254012817.cossh.myqcloud.com/comieswater/1517576665753.jpg